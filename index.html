<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Monitoreo de Red</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body.dark-mode {
      background-color: #121212 !important;
      color: #f8f9fa !important;
    }
    .dark-mode .card {
      background-color: #1e1e1e !important;
      color: #f8f9fa !important;
    }
    .dark-mode .table {
      color: #f8f9fa !important;
    }
    .dark-mode .navbar {
      background-color: #000 !important;
    }
    #deviceTableWrapper {
      max-height: 400px;
      overflow-y: auto;
    }
    #map {
      height: 400px;
    }
    .card-header-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 10;
    }
    .fullscreen {
      position: fixed !important;
      top: 70px;
      left: 0;
      width: 100% !important;
      height: calc(100% - 70px) !important;
      z-index: 2000;
      overflow: auto;
    }
    .fullscreen .card-body {
      height: 100%;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="https://via.placeholder.com/40" alt="Logo" class="me-2 rounded-circle">
      <span>Mi Empresa S.A.</span>
    </a>
    <div class="ms-auto">
      <button id="toggleDarkMode" class="btn btn-outline-light btn-sm">🌙</button>
    </div>
  </nav>

  <!-- Contenido -->
  <div class="container my-4">
    <div class="row g-4">

      <!-- Ancho de Banda -->
      <div class="col-md-6 dashboard-card">
        <div class="card shadow-sm position-relative" id="card-bandwidth">
          <button class="btn btn-sm btn-outline-secondary card-header-btn" onclick="toggleFullscreen('card-bandwidth')">⤢</button>
          <div class="card-body">
            <h5 class="card-title">Uso de Ancho de Banda</h5>
            <div class="d-flex gap-2 mb-3">
              <select id="timeRange" class="form-select form-select-sm w-auto">
                <option value="60">Última hora</option>
                <option value="120">Últimas 2 horas</option>
                <option value="300">Últimas 5 horas</option>
                <option value="720">Últimas 12 horas</option>
                <option value="1440">Últimas 24 horas</option>
              </select>
              <select id="datasetSelect" class="form-select form-select-sm w-auto">
                <option value="both">Subida y Bajada</option>
                <option value="upload">Solo Subida</option>
                <option value="download">Solo Bajada</option>
              </select>
            </div>
            <canvas id="bandwidthChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Latencia -->
      <div class="col-md-6 dashboard-card">
        <div class="card shadow-sm position-relative" id="card-latency">
          <button class="btn btn-sm btn-outline-secondary card-header-btn" onclick="toggleFullscreen('card-latency')">⤢</button>
          <div class="card-body">
            <h5 class="card-title">Latencia Promedio (ms)</h5>
            <canvas id="latencyChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Dispositivos -->
      <div class="col-md-6 dashboard-card">
        <div class="card shadow-sm position-relative" id="card-devices">
          <button class="btn btn-sm btn-outline-secondary card-header-btn" onclick="toggleFullscreen('card-devices')">⤢</button>
          <div class="card-body">
            <h5 class="card-title">Dispositivos Conectados</h5>
            <canvas id="devicesChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Mapa -->
      <div class="col-md-6 dashboard-card">
        <div class="card shadow-sm position-relative" id="card-map">
          <button class="btn btn-sm btn-outline-secondary card-header-btn" onclick="toggleFullscreen('card-map')">⤢</button>
          <div class="card-body">
            <h5 class="card-title">Mapa de Ubicación</h5>
            <div id="map"></div>
          </div>
        </div>
      </div>

      <!-- Tabla de dispositivos -->
      <div class="col-12 dashboard-card">
        <div class="card shadow-sm position-relative" id="card-table">
          <button class="btn btn-sm btn-outline-secondary card-header-btn" onclick="toggleFullscreen('card-table')">⤢</button>
          <div class="card-body">
            <h5 class="card-title">Detalles de Dispositivos</h5>
            <div id="deviceTableWrapper">
              <table class="table table-striped" id="deviceTable">
                <thead>
                  <tr>
                    <th onclick="sortTable(0)">IP</th>
                    <th onclick="sortTable(1)">País</th>
                    <th onclick="sortTable(2)">Estado</th>
                    <th onclick="sortTable(3)">Uso (%)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Scripts -->
  <script>
    const random = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const estados = [
      { text: "Activo", class: "success" },
      { text: "Caído", class: "danger" },
      { text: "Inestable", class: "warning" }
    ];
    const paises = {
      "Guatemala": [15.7835, -90.2308],
      "El Salvador": [13.7942, -88.8965],
      "España": [40.4637, -3.7492],
      "Costa Rica": [9.7489, -83.7534],
      "Colombia": [4.5709, -74.2973],
      "Perú": [-9.19, -75.0152]
    };

    let dispositivos = [];
    let markers = [];
    let map;
    let sortDirection = {};

    function generarDispositivos() {
      let i = 1;
      Object.keys(paises).forEach(pais => {
        for (let j = 0; j < 25; j++) {
          const estado = estados[random(0,2)];
          dispositivos.push({
            ip: `192.168.0.${i++}`,
            pais: pais,
            estado: estado,
            uso: random(0,100)
          });
        }
      });
    }

    // --- Gráficas ---
    function generarEtiquetas(minutos) {
      let etiquetas = [];
      for (let i = minutos; i > 0; i -= Math.floor(minutos/10)) etiquetas.push(`${i}m`);
      return etiquetas.reverse();
    }

    const bandwidthChart = new Chart(document.getElementById('bandwidthChart'), {
      type: 'line',
      data: {
        labels: generarEtiquetas(60),
        datasets: [
          {
            label: 'Subida',
            data: Array.from({length: 10}, () => random(10,50)),
            borderColor: 'blue',
            fill: false
          },
          {
            label: 'Bajada',
            data: Array.from({length: 10}, () => random(20,100)),
            borderColor: 'green',
            fill: false
          }
        ]
      }
    });

    const latencyChart = new Chart(document.getElementById('latencyChart'), {
      type: 'bar',
      data: {
        labels: ['Servidor A','Servidor B','Servidor C'],
        datasets: [{
          label: 'ms',
          data: [random(10,80), random(10,80), random(10,80)],
          backgroundColor: ['green','orange','red']
        }]
      }
    });

    const devicesChart = new Chart(document.getElementById('devicesChart'), {
      type: 'doughnut',
      data: {
        labels: ['Activos','Caídos','Inestables'],
        datasets: [{
          data: [0,0,0],
          backgroundColor: ['#198754','#dc3545','#ffc107']
        }]
      }
    });

    const deviceTable = document.querySelector("#deviceTable tbody");

    function actualizarTablaYChart() {
      deviceTable.innerHTML = "";
      let conteo = { "Activo": 0, "Caído": 0, "Inestable": 0 };

      dispositivos.forEach(d => {
        d.estado = estados[random(0,2)];
        d.uso = random(0,100);
        conteo[d.estado.text]++;

        deviceTable.innerHTML += `
          <tr>
            <td>${d.ip}</td>
            <td>${d.pais}</td>
            <td><span class="badge bg-${d.estado.class}">${d.estado.text}</span></td>
            <td>${d.uso}%</td>
          </tr>
        `;
      });

      devicesChart.data.datasets[0].data = [
        conteo["Activo"], conteo["Caído"], conteo["Inestable"]
      ];
      devicesChart.update();

      markers.forEach(m => map.removeLayer(m));
      markers = [];
      dispositivos.forEach(d => {
        const [lat, lon] = paises[d.pais];
        const marker = L.circleMarker([lat + Math.random()/5 - 0.1, lon + Math.random()/5 - 0.1], {
          radius: 6,
          color: d.estado.class === "success" ? "green" : d.estado.class === "danger" ? "red" : "orange",
          fillOpacity: 0.8
        }).bindPopup(`<b>${d.ip}</b><br>${d.pais}<br>${d.estado.text}<br>Uso: ${d.uso}%`);
        marker.addTo(map);
        markers.push(marker);
      });
    }

    // Inicializar mapa
    function initMap() {
      map = L.map('map').setView([15, -40], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
      }).addTo(map);
    }

    // Dark Mode
    document.getElementById("toggleDarkMode").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      toggleDarkMode.textContent = document.body.classList.contains("dark-mode") ? "☀️" : "🌙";
    });

    // Ordenar tabla
    function sortTable(colIndex) {
      const rows = Array.from(deviceTable.querySelectorAll("tr"));
      const dir = sortDirection[colIndex] = !sortDirection[colIndex];
      rows.sort((a, b) => {
        const x = a.children[colIndex].innerText;
        const y = b.children[colIndex].innerText;
        return dir ? x.localeCompare(y, 'es', {numeric: true}) : y.localeCompare(x, 'es', {numeric: true});
      });
      deviceTable.innerHTML = "";
      rows.forEach(r => deviceTable.appendChild(r));
    }

    // Fullscreen toggle
    function toggleFullscreen(cardId) {
      const card = document.getElementById(cardId);
      const expanded = card.classList.toggle("fullscreen");
      if (expanded) {
        const backBtn = document.createElement("button");
        backBtn.innerText = "← Volver al Dashboard";
        backBtn.className = "btn btn-primary m-2";
        backBtn.onclick = () => card.classList.remove("fullscreen");
        card.querySelector(".card-body").prepend(backBtn);
      } else {
        card.querySelector("button.btn-primary")?.remove();
      }
    }

    // Ejecutar
    generarDispositivos();
    initMap();
    actualizarTablaYChart();

    setInterval(() => {
      bandwidthChart.data.datasets.forEach(ds => {
        ds.data.shift();
        ds.data.push(random(20,100));
      });
      bandwidthChart.update();

      latencyChart.data.datasets[0].data = [random(10,80), random(10,80), random(10,80)];
      latencyChart.update();

      actualizarTablaYChart();
    }, 5000);

    // Selector de rango de tiempo
    document.getElementById("timeRange").addEventListener("change", e => {
      const mins = parseInt(e.target.value);
      bandwidthChart.data.labels = generarEtiquetas(mins);
      bandwidthChart.data.datasets.forEach(ds => {
        ds.data = Array.from({length: 10}, () => random(20,100));
      });
      bandwidthChart.update();
    });

    // Selector de dataset
    document.getElementById("datasetSelect").addEventListener("change", e => {
      const value = e.target.value;
      if (value === "upload") {
        bandwidthChart.data.datasets[0].hidden = false;
        bandwidthChart.data.datasets[1].hidden = true;
      } else if (value === "download") {
        bandwidthChart.data.datasets[0].hidden = true;
        bandwidthChart.data.datasets[1].hidden = false;
      } else {
        bandwidthChart.data.datasets[0].hidden = false;
        bandwidthChart.data.datasets[1].hidden = false;
      }
      bandwidthChart.update();
    });
  </script>
</body>
</html>